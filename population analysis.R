# Code to read in UK populations from NOMIS download



###############################################.
## Packages/Filepaths ----
###############################################.
library(dplyr)
library(readr)
library(tidyr) # long to wide format
library(ggplot2)
library(flextable)
library(janitor)

# Varies filepaths depending on if using server or not and what organisation uses it.
if (exists("organisation") == TRUE) { #Health Scotland
  if (organisation == "HS") { 
    pop_lookup <- "X:/ScotPHO Profiles/Data/Lookups/Population/"
    geo_lookup <- "X:/ScotPHO Profiles/Data/Lookups/Geography/"
  }
} else  { #ISD, first server then desktop
  if (sessionInfo()$platform %in% c("x86_64-redhat-linux-gnu (64-bit)", "x86_64-pc-linux-gnu (64-bit)")) {
    pop_lookup <- "/PHI_conf/ScotPHO/Profiles/Data/Lookups/Population/"
    geo_lookup <- "/PHI_conf/ScotPHO/Profiles/Data/Lookups/Geography/"
    covid_lookups <- "/PHI_conf/ScotPHO/Profiles/Projects/Covid vulnerability/Lookups/"
  } else {
    pop_lookup <- "//stats/ScotPHO/Profiles/Data/Lookups/Population/"
    geo_lookup <- "//stats/ScotPHO/Profiles/Data/Lookups/Geography/"
    covid_lookups <- "//stats/ScotPHO/Profiles/Projects/Covid vulnerability/Lookups/"
  }
}

source("1.indicator_analysis.R") #Normal indicator functions




###############################################.
## UK nation population comparisons.


#Read in population file downloaded from NOMIS
data_ukpop <- read.csv(file=paste0(covid_lookups, "UK 2018 Population.csv")) %>%
pivot_longer(cols = starts_with("age"), #convert data file to long format for manipulations
  names_to = "age",
  values_to = "pop") %>%
mutate(age=((gsub("age|plus","",age)))) %>%
subset(!(area_name %in% c("Great Britain","England and Wales")))


# Add 5 year age bands 
data_popbands <- data_ukpop %>%
  subset(age!="all" & sex !="all") %>%
  mutate(age=as.numeric(age)) %>%
  create_agegroups() %>%
  group_by(area_type,code, area_name, sex, age_grp) %>%
  summarise(pop=sum(pop)) %>%
  ungroup()

  
# dataset for total populations by region (ignoring sex)
data_totalpop <- data_ukpop %>%
  subset(age=="all" & sex =="all") %>%
  mutate(total_pop=pop) %>%
  select (area_type,code, area_name, total_pop)


# dataset for 65+ year old population
data_pop65 <- data_ukpop %>%
  subset(age!="all" & age>=65) %>%
  group_by(code, sex) %>%
  summarise(pop= sum(pop)) %>%
  mutate(age_grp="pop65") %>%
  ungroup()

# dataset for 75+ year old population
data_pop75 <- data_ukpop %>%
  subset(age!="all" & age>=75) %>%
  group_by(code, sex) %>%
  summarise(pop= sum(pop)) %>%
  mutate(age_grp="pop75") %>%
  ungroup() 

# dataset for 85+ year old population
data_pop85 <- data_ukpop %>%
  subset(age!="all" & age>=85) %>%
  group_by(code, sex) %>%
  summarise(pop= sum(pop)) %>%
  mutate(age_grp="pop85") %>%
  ungroup() 
  
#bind age group datasets
pops <- bind_rows(data_pop65,data_pop75,data_pop85)

#match on total populations for whole area (tot pop ignores gender)
pops <- left_join(pops,data_totalpop, by="code")

#calculate percentages of population
pops <- pops %>%
  mutate(percent=round_half_up((pop/total_pop*100),1))

# total population number summary table
country_totsummary <- pops %>%
  subset(area_type=="country" & sex=="all") %>%
  select(age_grp,area_name,total_pop)%>%
  pivot_wider(names_from = area_name, values_from = total_pop) %>%
  mutate(age_grp=case_when(age_grp=="pop65" ~"65+ years",
                           age_grp=="pop75" ~"75+ years",
                           age_grp=="pop85" ~"85+ years"))

# total population percentage summary table
country_psummary <- pops %>%
  subset(area_type=="country" & sex=="all") %>%
  select(age_grp,area_name,percent)%>%
  pivot_wider(names_from = area_name, values_from = percent) %>%
  mutate(age_grp=case_when(age_grp=="pop65" ~"65+ years",
                           age_grp=="pop75" ~"75+ years",
                           age_grp=="pop85" ~"85+ years"))
flextable(country_psummary, 
         col_keys =c("age_grp","United Kingdom", "Scotland",
                     "England", "Northern Ireland", "Wales")) %>%
         set_header_labels(age_grp = "Age Group") %>%
  autofit()

flextable(country_totsummary, 
          col_keys =c("age_grp","United Kingdom", "Scotland",
                      "England", "Northern Ireland", "Wales")) %>%
  set_header_labels(age_grp = "Age Group") %>%
  colformat_num(big.mark = ",",  digits = 0) %>%
  autofit()





####################################################################################
##?Population pyramid.


population <-  data_popbands  %>%
  subset(area_name=="Scotland") %>%
  mutate(tot_pop=sum(pop),
         ppop=(pop/tot_pop)*100,
         age_grp=as.numeric(age_grp)) %>%
  arrange(age_grp) %>%
  mutate(agegroup = factor(age_grp))
         

agelevels <- c("0-4", "5-9", "10-14", "15-19", "20-24",
           "25-29", "30-34", "35-39", "40-44",
           "45-49", "50-54", "55-59", "60-64",
           "65-69", "70-74", "75-79", "80-84",
           "85-89", "90+")

names(agelevels) <- levels(population$agegroup)




#png(filename = "~/R/pyramid.png", width = 900, height = 1000, type = "cairo")          


ggplot(population, aes(x = agegroup, color = sex))


ggplot(population, aes(x = agegroup, color = sex))+
  geom_linerange(data = population[population$sex=="male",], 
                 aes(ymin = -0.3, ymax = -0.3+ppop), size = 3.5, alpha = 0.8)+
  geom_linerange(data = population[population$sex=="female",], 
                 aes(ymin = 0.3, ymax = 0.3+ppop), size = 3.5, alpha = 0.8)+
  geom_label(aes(x = agegroup, y = 0, label = agegroup, family = "Ubuntu Condensed"), 
             inherit.aes = F,
             size = 3.5, label.padding = unit(0.0, "lines"), label.size = 0,
             label.r = unit(0.0, "lines"), fill = "#EFF2F4", alpha = 0.9, color = "#5D646F")+
  scale_y_continuous(breaks = c(c(-2, -1.5, -1, -0.5, 0) + -0.3, c(0, 0.5, 1, 1.5, 2)+0.3),
                     labels = c("2", "1.5", "1", "0.5", "0", "0", "0.5", "1", "1.5", "2"))+
  #facet_wrap(~year, ncol = 2)+
  coord_flip()+
  labs(title = "Піраміда населення України",
       subtitle = "Статево-вікові групи у 1990-2015 роках, млн осіб",
       caption = "Дані: Держкомстат України")+
  scale_color_manual(name = "", values = c(male = "#3E606F", female = "#8C3F4D"),
                     labels = c("жінки", "чоловіки"))+
  theme_minimal(base_family = "Ubuntu Condensed")+
  theme(text = element_text(color = "#3A3F4A"),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_line(linetype = "dotted", size = 0.3, color = "#3A3F4A"),
        axis.title = element_blank(),
        plot.title = element_text(face = "bold", size = 36, margin = margin(b = 10), hjust = 0.030),
        plot.subtitle = element_text(size = 16, margin = margin(b = 20), hjust = 0.030),
        plot.caption = element_text(size = 14, margin = margin(b = 10, t = 50), color = "#5D646F"),
        axis.text.x = element_text(size = 12, color = "#5D646F"),
        axis.text.y = element_blank(),
        strip.text = element_text(color = "#5D646F", size = 18, face = "bold", hjust = 0.030),
        plot.background = element_rect(fill = "#EFF2F4"),
        plot.margin = unit(c(2, 2, 2, 2), "cm"),
        legend.position = "top",
        #legend.margin  = unit(0.1, "lines"),
        legend.text  = element_text(family = "Ubuntu Condensed", size = 14),
        legend.text.align = 0)
