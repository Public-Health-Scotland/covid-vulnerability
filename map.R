# Map of vulnerability

# Prepare function for map
###############################################.
## Packages/Filepaths/Functions ----
###############################################.
library(leaflet)
library(htmlwidgets)
library(rgdal) #for reading shapefiles
library(rgeos) #for reducing size of shapefiles
library(rmapshaper)
library(readr)

if (sessionInfo()$platform %in% c("x86_64-redhat-linux-gnu (64-bit)", "x86_64-pc-linux-gnu (64-bit)")) {
  shapefiles <- "/PHI_conf/ScotPHO/Profiles/Data/Shapefiles/"
} else  {
  shapefiles <- "//stats/ScotPHO/Profiles/Data/Shapefiles/"
}
source("1.indicator_analysis.R") #Normal indicator functions

###############################################.
## Get PCA data ----
###############################################.
ca_pca <- readRDS(paste0(data_folder, "pca results/ca_pca_final.rds"))
iz_pca <- readRDS(paste0(data_folder, "pca results/iz_pca_final.rds"))
dz_pca <- readRDS(paste0(data_folder, "pca results/dz_pca_final.rds"))

###############################################.
## Prepare or load shapefiles ----
###############################################.
iz_bound <- readRDS(paste0(shapefiles, "IZ_boundary.rds"))

iz_bound <- iz_bound %>% rmapshaper::ms_simplify(keep=0.050, keep_shapes = T)
saveRDS(iz_bound, "iz_boundary.rds")
iz_bound <- readRDS( "iz_boundary.rds")

iz_bound <- sp::merge(iz_bound, iz_pca, by='code')

names(iz_bound@data)[names(iz_bound@data)=="area_name.x"] <- "area_name"

saveRDS(iz_bound, "maps_app/data/iz_bound.rds")

#CA
ca_bound <- readRDS(paste0(shapefiles, "CA_boundary.rds"))
ca_bound <- sp::merge(ca_bound, ca_pca, by='code')

names(ca_bound@data)[names(ca_bound@data)=="area_name.x"] <- "area_name"

saveRDS(ca_bound, "maps_app/data/ca_bound.rds")

#DZ
dz11_shp <-readOGR('/conf/linkage/output/lookups/Unicode/Geography/Shapefiles/Data Zones 2011/',
                   "SG_DataZone_Bdry_2011") %>%
  setNames(tolower(names(.))) #variables to lower case

dz11_shp <- dz11_shp %>% rmapshaper::ms_simplify(keep=0.0050, keep_shapes = T)

# Transforming projection
dz11_shp <- spTransform(dz11_shp,  CRS("+ellps=WGS84 +proj=longlat +datum=WGS84 +no_defs"))

names(dz11_shp@data)[names(dz11_shp@data)=="datazone"] <- "code"
names(dz11_shp@data)[names(dz11_shp@data)=="name"] <- "area_name"

saveRDS(dz11_shp, paste0(shapefiles, "Datazone2011_boundary.rds"))

dz_bound <- readRDS(paste0(shapefiles, "Datazone2011_boundary.rds"))
dz_bound <- sp::merge(dz_bound, dz_pca, by='code')

names(dz_bound@data)[names(dz_bound@data)=="area_name.x"] <- "area_name"

saveRDS(dz_bound, "maps_app/data/dz_bound.rds")

##END

