# Map of vulnerability

# Prepare function for map
###############################################.
## Packages/Filepaths/Functions ----
###############################################.
library(leaflet)
library(htmlwidgets)
library(rgdal) #for reading shapefiles
library(rgeos) #for reducing size of shapefiles
library(rmapshaper)

if (sessionInfo()$platform %in% c("x86_64-redhat-linux-gnu (64-bit)", "x86_64-pc-linux-gnu (64-bit)")) {
  shapefiles <- "/PHI_conf/ScotPHO/Profiles/Data/Shapefiles/"
} else  {
  shapefiles <- "//stats/ScotPHO/Profiles/Data/Shapefiles/"
}
###############################################.
## Prepare or load shapefiles ----
###############################################.
iz_bound <- readRDS(paste0(shapefiles, "IZ_boundary.rds"))
ca_bound <- readRDS(paste0(shapefiles, "CA_boundary.rds"))

dz11_shp <-readOGR('/conf/linkage/output/lookups/Unicode/Geography/Shapefiles/Data Zones 2011/',
                   "SG_DataZone_Bdry_2011") %>%
  setNames(tolower(names(.))) #variables to lower case

dz11_shp <- dz11_shp %>% rmapshaper::ms_simplify(keep=0.0050, keep_shapes = T)

# Transforming projection
dz11_shp <- spTransform(dz11_shp,  CRS("+ellps=WGS84 +proj=longlat +datum=WGS84 +no_defs"))

names(dz11_shp@data)[names(dz11_shp@data)=="datazone"] <- "code"
names(dz11_shp@data)[names(dz11_shp@data)=="name"] <- "area_name"

saveRDS(dz11_shp, paste0(shapefiles, "Datazone2011_boundary.rds"))
dz_bound <- readRDS(paste0(shapefiles, "Datazone2011_boundary.rds"))

###############################################.
## Preparing leaflet maps ----
###############################################.

###############################################.
# DZ map 
map_dz <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data=dz_bound, group = "Social",
              color = "#444444", weight = 2, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                dz_bound$area_name, dz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = "blue", #Colours
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)
  ) %>% 
  addPolygons(data=dz_bound, group = "Clinical") %>% 
  addPolygons(data=dz_bound, group = "Demographical") %>% 
  addPolygons(data=dz_bound, group = "Overall") %>% 
  addLayersControl(
    baseGroups = c("Social", "Clinical", "Demographical", "Overall"),
    options = layersControlOptions(collapsed = FALSE)
  )



htmlwidgets::saveWidget(map_dz, selfcontained = F,
                        paste0(data_folder, "Maps/dz_vulnerability.html"))

###############################################.
# IZ map 

map_iz <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data=iz_bound, group = "Social",
              color = "#444444", weight = 2, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                iz_bound$area_name, iz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = "blue", #Colours
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)
  ) %>% 
  addPolygons(data=iz_bound, group = "Clinical") %>% 
  addPolygons(data=iz_bound, group = "Demographical") %>% 
  addPolygons(data=iz_bound, group = "Overall") %>% 
  addLayersControl(
    baseGroups = c("Social", "Clinical", "Demographical", "Overall"),
    options = layersControlOptions(collapsed = FALSE)
  )



htmlwidgets::saveWidget(map_iz, selfcontained = F,
                        paste0(data_folder, "Maps/iz_vulnerability.html"))

###############################################.
# CA map 

map_ca <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data=ca_bound, group = "Social",
              color = "#444444", weight = 2, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                ca_bound$area_name, ca_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = "blue", #Colours
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)
  ) %>% 
  addPolygons(data=ca_bound, group = "Clinical") %>% 
  addPolygons(data=ca_bound, group = "Demographical") %>% 
  addPolygons(data=ca_bound, group = "Overall") %>% 
  addLayersControl(
    baseGroups = c("Social", "Clinical", "Demographical", "Overall"),
    options = layersControlOptions(collapsed = FALSE)
  )



htmlwidgets::saveWidget(map_ca, selfcontained = F,
                        paste0(data_folder, "Maps/ca_vulnerability.html"))

