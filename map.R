# Map of vulnerability

# Prepare function for map
###############################################.
## Packages/Filepaths/Functions ----
###############################################.
library(leaflet)
library(htmlwidgets)
library(rgdal) #for reading shapefiles
library(rgeos) #for reducing size of shapefiles
library(rmapshaper)
library(readr)

if (sessionInfo()$platform %in% c("x86_64-redhat-linux-gnu (64-bit)", "x86_64-pc-linux-gnu (64-bit)")) {
  shapefiles <- "/PHI_conf/ScotPHO/Profiles/Data/Shapefiles/"
} else  {
  shapefiles <- "//stats/ScotPHO/Profiles/Data/Shapefiles/"
}
source("1.indicator_analysis.R") #Normal indicator functions

###############################################.
## Get PCA data ----
###############################################.
dz_eigen <- read_csv(paste0(data_folder, "pca results/dz_pca_eigenvalues.csv")) %>% 
  janitor::clean_names() %>% 
  rename(dim = x1)

dz_pca <- read_csv(paste0(data_folder, "pca results/dz_pca_coordinates.csv")) %>% 
  janitor::clean_names() %>% 
  rename(code = x1) %>% 
  mutate(comb_score2 = (dim_1*40.27415) + (dim_2*12.63047),
         dim_1_norm = as.vector(scales::rescale(dim_1, to=c(0,1))),
         dim_2_norm = as.vector(scales::rescale(dim_2, to=c(0,1))),
         comb_score = dim_1_norm +dim_2_norm,
         dim_1_rank = dense_rank(dim_1),
         dim_2_rank = dense_rank(dim_2),
         comb_score2_rank = dense_rank(comb_score2),
         comb_score_rank = dense_rank(comb_score)) %>% 
  select(code, dim_1, dim_2, comb_score, dim_1_rank, dim_2_rank, comb_score_rank)


write_csv(dz_pca, paste0(data_folder, "pca results/dz_ranks.csv"))

iz_pca <- read_csv(paste0(data_folder, "pca results/iz_pca_coordinates.csv")) %>% 
  janitor::clean_names() %>% 
  rename(code = x1) %>% 
  mutate(dim_1_norm = as.vector(scales::rescale(dim_1, to=c(0,1))),
         dim_2_norm = as.vector(scales::rescale(dim_2, to=c(0,1))),
         comb_score = dim_1_norm +dim_2_norm,
         dim_1_rank = dense_rank(dim_1),
         dim_2_rank = dense_rank(dim_2),
         comb_score_rank = dense_rank(comb_score)) %>% 
  select(code, dim_1, dim_2, comb_score, dim_1_rank, dim_2_rank, comb_score_rank)

write_csv(iz_pca, paste0(data_folder, "pca results/iz_ranks.csv"))


ca_pca <- read_csv(paste0(data_folder, "pca results/ca_pca_coordinates.csv")) %>% 
  janitor::clean_names() %>% 
  rename(code = x1) %>% 
  mutate(dim_1_norm = as.vector(scales::rescale(dim_1, to=c(0,1))),
         dim_2_norm = as.vector(scales::rescale(dim_2, to=c(0,1))),
         comb_score = dim_1_norm +dim_2_norm,
         dim_1_rank = dense_rank(dim_1),
         dim_2_rank = dense_rank(dim_2),
         comb_score_rank = dense_rank(comb_score)) %>% 
  select(code, dim_1, dim_2, comb_score, dim_1_rank, dim_2_rank, comb_score_rank)

write_csv(ca_pca, paste0(data_folder, "pca results/ca_ranks.csv"))

###############################################.
## Prepare or load shapefiles ----
###############################################.
iz_bound <- readRDS(paste0(shapefiles, "IZ_boundary.rds"))

iz_bound <- iz_bound %>% rmapshaper::ms_simplify(keep=0.050, keep_shapes = T)
saveRDS(iz_bound, "iz_boundary.rds")
iz_bound <- readRDS( "iz_boundary.rds")

iz_bound <- sp::merge(iz_bound, iz_pca, by='code')

ca_bound <- readRDS(paste0(shapefiles, "CA_boundary.rds"))
ca_bound <- sp::merge(ca_bound, ca_pca, by='code')

dz11_shp <-readOGR('/conf/linkage/output/lookups/Unicode/Geography/Shapefiles/Data Zones 2011/',
                   "SG_DataZone_Bdry_2011") %>%
  setNames(tolower(names(.))) #variables to lower case

dz11_shp <- dz11_shp %>% rmapshaper::ms_simplify(keep=0.0050, keep_shapes = T)

# Transforming projection
dz11_shp <- spTransform(dz11_shp,  CRS("+ellps=WGS84 +proj=longlat +datum=WGS84 +no_defs"))

names(dz11_shp@data)[names(dz11_shp@data)=="datazone"] <- "code"
names(dz11_shp@data)[names(dz11_shp@data)=="name"] <- "area_name"

saveRDS(dz11_shp, paste0(shapefiles, "Datazone2011_boundary.rds"))

dz_bound <- readRDS(paste0(shapefiles, "Datazone2011_boundary.rds"))
dz_bound <- sp::merge(dz_bound, dz_pca, by='code')

###############################################.
## Preparing leaflet maps ----
###############################################.
labels_map <- c("Least vulnerable", "", "", "", "Most vulnerable")
###############################################.
# DZ map 
dz_pal_over <- colorQuantile("YlOrRd", dz_bound@data$comb_score_rank, n = 5)
dz_pal_clinsoc <- colorQuantile("YlOrRd", dz_bound@data$dim_1_rank, n = 5)
dz_pal_demog <- colorQuantile("YlOrRd", dz_bound@data$dim_2_rank, n = 5)

map_dz <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data=dz_bound, group = "Overall",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                dz_bound$area_name, dz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~dz_pal_over(comb_score_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addPolygons(data=dz_bound, group = "Social/Clinical",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                dz_bound$area_name, dz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~dz_pal_clinsoc(dim_1_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)
  ) %>% 
  addPolygons(data=dz_bound, group = "Demographic",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                dz_bound$area_name, dz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~dz_pal_demog(dim_2_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addLayersControl(
    baseGroups = c("Overall", "Social/Clinical", "Demographic"),
    options = layersControlOptions(collapsed = FALSE)) %>% 
  addLegend(pal = dz_pal_over, values = dz_bound@data$comb_score_rank,  
            labFormat = function(type, cuts, p) { 
              labels_map }) #custom legend

saveRDS(map_dz, paste0(data_folder, "Maps/dz_vulnerability.rds"))

htmlwidgets::saveWidget(map_dz, selfcontained = F,
                        paste0(data_folder, "Maps/dz_vulnerability.html"))

###############################################.
# IZ map 

iz_pal_over <- colorQuantile("YlOrRd", iz_bound@data$comb_score_rank, n = 5)
iz_pal_clinsoc <- colorQuantile("YlOrRd", iz_bound@data$dim_1_rank, n = 5)
iz_pal_demog <- colorQuantile("YlOrRd", iz_bound@data$dim_2_rank, n = 5)

map_iz <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data=iz_bound, group = "Overall",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                iz_bound$area_name, iz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~iz_pal_over(comb_score_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addPolygons(data=iz_bound, group = "Social/Clinical",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                iz_bound$area_name, iz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~iz_pal_clinsoc(dim_1_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)
  ) %>% 
  addPolygons(data=iz_bound, group = "Demographic",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                iz_bound$area_name, iz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~iz_pal_demog(dim_2_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addLayersControl(
    baseGroups = c("Overall", "Social/Clinical", "Demographic"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  addLegend(pal = iz_pal_over, values = iz_bound@data$comb_score_rank, 
            labFormat = function(type, cuts, p) { 
              labels_map }) #custom legend

saveRDS(map_iz, paste0(data_folder, "Maps/iz_vulnerability.rds"))


htmlwidgets::saveWidget(map_iz, selfcontained = F,
                        paste0(data_folder, "Maps/iz_vulnerability.html"))

###############################################.
# CA map 
ca_pal_over <- colorQuantile("YlOrRd", ca_bound@data$comb_score_rank, n = 5)
ca_pal_clinsoc <- colorQuantile("YlOrRd", ca_bound@data$dim_1_rank, n = 5)
ca_pal_demog <- colorQuantile("YlOrRd", ca_bound@data$dim_2_rank, n = 5)

map_ca <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data=ca_bound, group = "Overall",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                ca_bound$area_name, ca_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~ca_pal_over(comb_score_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addPolygons(data=ca_bound, group = "Social/Clinical",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                ca_bound$area_name, ca_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~ca_pal_clinsoc(dim_1_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)
  ) %>% 
  addPolygons(data=ca_bound, group = "Demographic",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                ca_bound$area_name, ca_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~ca_pal_demog(dim_2_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addLayersControl(
    baseGroups = c("Overall", "Social/Clinical", "Demographic"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  addLegend(pal = ca_pal_over, values = ca_bound@data$comb_score_rank, 
            labFormat = function(type, cuts, p) { 
              labels_map }) #custom palette

saveRDS(map_ca, paste0(data_folder, "Maps/ca_vulnerability.rds"))

htmlwidgets::saveWidget(map_ca, selfcontained = F,
                        paste0(data_folder, "Maps/ca_vulnerability.html"))

##END

