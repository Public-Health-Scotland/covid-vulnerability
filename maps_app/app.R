# Shiny app to present the vulnerability maps

library(shiny)
library(leaflet)
library(shinyWidgets)
library(shinycssloaders)

#Download button for charts, just changing the icon
savechart_button <- function(outputId, label = "Save chart", class=NULL){
  tags$a(id = outputId, class = paste("btn btn-default shiny-download-link", class), 
         href = "", target = "_blank", download = NA, icon("image"), label)
}

#Function to create color palettes for map
create_map_palette <- function(dataset, vulnerability){
  
  if (vulnerability == "overall") {
    case_when(dataset$comb_quintile == 5 ~ "#FFFFB2",
              dataset$comb_quintile == 4 ~ "#FECC5C",
              dataset$comb_quintile == 3 ~ "#FD8D3C",
              dataset$comb_quintile == 2 ~ "#F03B20",
              dataset$comb_quintile == 1 ~ "#BD0026",
              TRUE ~ '#ffffff')
  } else if (vulnerability == "clinsoc") {
    case_when(dataset$dim1_quintile == 5 ~ "#FFFFB2",
              dataset$dim1_quintile == 4 ~ "#FECC5C",
              dataset$dim1_quintile == 3 ~ "#FD8D3C",
              dataset$dim1_quintile == 2 ~ "#F03B20",
              dataset$dim1_quintile == 1 ~ "#BD0026",
              TRUE ~ '#ffffff')
  } else if (vulnerability == "demog") {
    case_when(dataset$dim2_quintile == 5 ~ "#FFFFB2",
              dataset$dim2_quintile == 4 ~ "#FECC5C",
              dataset$dim2_quintile == 3 ~ "#FD8D3C",
              dataset$dim2_quintile == 2 ~ "#F03B20",
              dataset$dim2_quintile == 1 ~ "#BD0026",
              TRUE ~ '#ffffff')
  }

}

###############################################.
## Preparing leaflet maps ----
###############################################.
# This needs to be done in the app as bug with leaflet
# see https://community.rstudio.com/t/leaflet-map-working-in-local-shiny-but-couldnt-normalize-path-error-on-shinyapps-io/35638
dz_bound <- readRDS("data/dz_bound.rds")
iz_bound <- readRDS("data/iz_bound.rds")
ca_bound <- readRDS("data/ca_bound.rds")


# labels
labels_map <- c("Most vulnerable", "", "", "", "Least vulnerable")
#color palette
col_pal <- c("#BD0026", "#F03B20", "#FD8D3C", "#FECC5C", "#FFFFB2")
###############################################.
# DZ map 
dz_pal_over <- create_map_palette(dz_bound, "overall")
dz_pal_clinsoc <- create_map_palette(dz_bound, "clinsoc")
dz_pal_demog <- create_map_palette(dz_bound, "demog")

map_dz <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data=dz_bound, group = "Overall",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s  %s</strong>",
                dz_bound$area_name, dz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = dz_pal_over,
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addPolygons(data=dz_bound, group = "Social/Clinical",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s  %s</strong>",
                dz_bound$area_name, dz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = dz_pal_clinsoc,
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)
  ) %>% 
  addPolygons(data=dz_bound, group = "Demographic",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s  %s</strong>",
                dz_bound$area_name, dz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = dz_pal_demog,
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addLayersControl(
    baseGroups = c("Overall", "Social/Clinical", "Demographic"),
    options = layersControlOptions(collapsed = FALSE)) %>% 
  addLegend(colors = col_pal, labels = labels_map )


###############################################.
# IZ map 

iz_pal_over <- create_map_palette(iz_bound, "overall")
iz_pal_clinsoc <- create_map_palette(iz_bound, "clinsoc")
iz_pal_demog <- create_map_palette(iz_bound, "demog")

map_iz <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data=iz_bound, group = "Overall",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s  %s</strong>",
                iz_bound$area_name, iz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = create_map_palette(iz_bound, "overall"),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addPolygons(data=iz_bound, group = "Social/Clinical",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s  %s</strong>",
                iz_bound$area_name, iz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = create_map_palette(iz_bound, "clinsoc"),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)
  ) %>% 
  addPolygons(data=iz_bound, group = "Demographic",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s  %s</strong>",
                iz_bound$area_name, iz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = create_map_palette(iz_bound, "demog"),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addLayersControl(
    baseGroups = c("Overall", "Social/Clinical", "Demographic"),
    options = layersControlOptions(collapsed = FALSE)) %>% 
  addLegend(colors = col_pal, labels = labels_map )

###############################################.
# CA map 
ca_pal_over <- create_map_palette(ca_bound, "overall")
ca_pal_clinsoc <- create_map_palette(ca_bound, "clinsoc")
ca_pal_demog <- create_map_palette(ca_bound, "demog")

map_ca <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data=ca_bound, group = "Overall",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s  %s</strong>",
                ca_bound$area_name, ca_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ca_pal_over,
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addPolygons(data=ca_bound, group = "Social/Clinical",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s  %s</strong>",
                ca_bound$area_name, ca_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ca_pal_clinsoc,
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addPolygons(data=ca_bound, group = "Demographic",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s  %s</strong>",
                ca_bound$area_name, ca_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ca_pal_demog,
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addLayersControl(
    baseGroups = c("Overall", "Social/Clinical", "Demographic"),
    options = layersControlOptions(collapsed = FALSE)) %>% 
  addLegend(colors = col_pal, labels = labels_map )

###############################################.
## UI ----
###############################################.
ui <- fluidPage(
  includeCSS("www/styles.css"),
  tags$link(rel="shortcut icon", href="favicon_scotpho.ico"), #Icon for browser tab
   # Application title
   titlePanel(div(tags$a(img(src="scotpho_reduced.png", height=40), href= "http://www.scotpho.org.uk/"),
                  "ScotPHO COVID-19 Community Vulnerability", style = "position: relative; top: -5px;"),
              windowTitle = "ScotPHO COVID-19 Community Vulnerability"),
  "In addition to clinical and public health responses to the Coronavirus (COVID-19) pandemic, action will
    be required to mitigate a range of associated social harms.",br(),
  "ScotPHO have produced maps to illustrate their COVID-19 community vulnerability measure based on demographic, social and clinical indicators relevant either directly to COVID-19 or to socio-economic factors that are likely to 
    modify the impacts of the pandemic and efforts to delay it.",br(),
  "A briefing paper and summary analysis have also been produced to complement these maps & provide additionall detail of methodology.",br(),
  tags$ul( 
    #Link to Briefing Paper
    tags$li(class= "li-custom", tags$a(href="https://www.scotpho.org.uk/media/1955/scotpho-covid-19-community-vulnerability-brieifing-20200325.docx",
                                       "ScotPHO COVID-19 Community Vulnerability Briefing.doc (25/03/2020)",  class="externallink")), 
    #Link to Excel analysis
    tags$li(class= "li-custom", tags$a(href="https://www.scotpho.org.uk/media/1956/scotpho-covid-19-community-vulnerability-analysis_v10.xlsx",
                                       "ScotPHO CoVID-19 Community Vulnerability Analisys V1.0.xls (25/03/2020)",  class="externallink"))), br(),
  p("Contact: ",tags$b(tags$a(href="mailto:ScotPHO@nhs.net", "ScotPHO@nhs.net", class="externallink"))),br(),
      sidebarPanel(
        radioGroupButtons("map_area", 
                          label= "Select a geography level", 
                          choices = c("Council area", "Intermediate zone",  "Data zone"), 
                          status = "primary", justified = TRUE, direction = "vertical"),
        savechart_button('download_mapplot', 'Save map', class= "down")
        # actionButton("browser", "Browser")
        ), #sidebar panel bracket
      mainPanel(
        withSpinner(leafletOutput("map_vuln", width="100%",height="550px"))
      ),#mainpanel bracket
  p("Methodology", style = "font-weight: bold; color: black;"), #
  "The measures presented in this tool have been developed in response to COVID-19 and may be further refined over time.",br(),
  p("ScotPHO have used data routinely available from the Health and Wellbeing Profile in the ",tags$a(href="https://scotland.shinyapps.io/ScotPHO_profiles_tool/","ScotPHO Online Profiles Tool",  class="externallink")," (with the exception of the Diabetes Hospitalisations indicator). The indicators were chosen on the basis of being immediately available to the ScotPHO team; and were demographic or clinical indicators deemed to be directly relevant to COVID-19, clinical indicators relevant to other demands on clinical services or population health, or social factors that would be likely to modify the impact of COVID-19 on communities. We used the most recent period available in all cases (depending on the indicator this could be a single year value or an multi-year aggregated value.)."),
  p("We combined these indicators into a single measure for overall vulnerability across each of the three domains using an approach called principal components analysis (PCA)."), br()
  ) #fulidpage bracket

###############################################.
## Server ----
###############################################.

server <- function(input, output) {
   
  # observeEvent(input$browser, browser())
  
   output$map_vuln <- renderLeaflet({

     if (input$map_area == "Data zone") {
       map_dz
     } else if (input$map_area == "Intermediate zone") {
       map_iz
     } else if (input$map_area == "Council area") {
       map_ca
     }
     
   })
   
   
   output$test <- renderText({print(input$map_vuln_id)})
   
   # Downloading the maps
   plot_map_download <- function(){

     if (input$map_area == "Data zone") {
       color_map <- case_when(input$map_vuln_groups == "Overall" ~dz_pal_over,
                              input$map_vuln_groups == "Social/Clinical" ~dz_pal_clinsoc,
                              input$map_vuln_groups == "Demographic" ~dz_pal_demog)
       
       map_bound <- dz_bound
     } else if (input$map_area == "Intermediate zone") {
       color_map <- case_when(input$map_vuln_groups == "Overall" ~iz_pal_over,
                              input$map_vuln_groups == "Social/Clinical" ~iz_pal_clinsoc,
                              input$map_vuln_groups == "Demographic" ~iz_pal_demog)
       
       map_bound <- iz_bound
     } else if (input$map_area == "Council area") {

       color_map <- case_when(input$map_vuln_groups == "Overall" ~ ca_pal_over,
                              input$map_vuln_groups == "Social/Clinical" ~ ca_pal_clinsoc,
                              input$map_vuln_groups == "Demographic" ~ ca_pal_demog)
  
       map_bound <- ca_bound

     }
     
     title_map <- paste0("ScotPHO COIVD-19 Community: ", input$map_vuln_groups)
     

     plot(map_bound, col=color_map)
     title(title_map, cex.main = 20,  line = -10) # adding title

   }
   
   
   #Donwloading map chart
   output$download_mapplot <- downloadHandler(
     filename = 'map.png',
     content = function(file){
       png(file, width = 6000, height = 6000, units = "px")
       plot_map_download()
       dev.off()
     })
   
} # server end

# Run the application 
shinyApp(ui = ui, server = server)

