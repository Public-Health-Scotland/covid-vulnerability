# Shiny app to present the vulnerability maps

library(shiny)
library(leaflet)
library(shinyWidgets)
library(shinycssloaders)

#Download button for charts, just changing the icon
savechart_button <- function(outputId, label = "Save chart", class=NULL){
  tags$a(id = outputId, class = paste("btn btn-default shiny-download-link", class), 
         href = "", target = "_blank", download = NA, icon("image"), label)
}

###############################################.
## Preparing leaflet maps ----
###############################################.
# This needs to be done in the app as bug with leaflet
# see https://community.rstudio.com/t/leaflet-map-working-in-local-shiny-but-couldnt-normalize-path-error-on-shinyapps-io/35638
dz_bound <- readRDS("data/dz_bound.rds")
iz_bound <- readRDS("data/iz_bound.rds")
ca_bound <- readRDS("data/ca_bound.rds")


# labels
labels_map <- c("Least vulnerable", "", "", "", "Most vulnerable")
###############################################.
# DZ map 
dz_pal_over <- colorQuantile("YlOrRd", dz_bound@data$comb_score_rank, n = 5)
dz_pal_clinsoc <- colorQuantile("YlOrRd", dz_bound@data$dim_1_rank, n = 5)
dz_pal_demog <- colorQuantile("YlOrRd", dz_bound@data$dim_2_rank, n = 5)

map_dz <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data=dz_bound, group = "Overall",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                dz_bound$area_name, dz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~dz_pal_over(comb_score_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addPolygons(data=dz_bound, group = "Social/Clinical",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                dz_bound$area_name, dz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~dz_pal_clinsoc(dim_1_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)
  ) %>% 
  addPolygons(data=dz_bound, group = "Demographic",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                dz_bound$area_name, dz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~dz_pal_demog(dim_2_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addLayersControl(
    baseGroups = c("Overall", "Social/Clinical", "Demographic"),
    options = layersControlOptions(collapsed = FALSE)) %>% 
  addLegend(pal = dz_pal_over, values = dz_bound@data$comb_score_rank,  
            labFormat = function(type, cuts, p) { 
              labels_map }) #custom legend


###############################################.
# IZ map 

iz_pal_over <- colorQuantile("YlOrRd", iz_bound@data$comb_score_rank, n = 5)
iz_pal_clinsoc <- colorQuantile("YlOrRd", iz_bound@data$dim_1_rank, n = 5)
iz_pal_demog <- colorQuantile("YlOrRd", iz_bound@data$dim_2_rank, n = 5)

map_iz <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data=iz_bound, group = "Overall",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                iz_bound$area_name, iz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~iz_pal_over(comb_score_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addPolygons(data=iz_bound, group = "Social/Clinical",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                iz_bound$area_name, iz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~iz_pal_clinsoc(dim_1_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)
  ) %>% 
  addPolygons(data=iz_bound, group = "Demographic",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                iz_bound$area_name, iz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~iz_pal_demog(dim_2_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addLayersControl(
    baseGroups = c("Overall", "Social/Clinical", "Demographic"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  addLegend(pal = iz_pal_over, values = iz_bound@data$comb_score_rank, 
            labFormat = function(type, cuts, p) { 
              labels_map }) #custom legend

###############################################.
# CA map 
ca_pal_over <- colorQuantile("YlOrRd", ca_bound@data$comb_score_rank, n = 5)
ca_pal_clinsoc <- colorQuantile("YlOrRd", ca_bound@data$dim_1_rank, n = 5)
ca_pal_demog <- colorQuantile("YlOrRd", ca_bound@data$dim_2_rank, n = 5)

map_ca <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data=ca_bound, group = "Overall",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                ca_bound$area_name, ca_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~ca_pal_over(comb_score_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addPolygons(data=ca_bound, group = "Social/Clinical",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                ca_bound$area_name, ca_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~ca_pal_clinsoc(dim_1_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)
  ) %>% 
  addPolygons(data=ca_bound, group = "Demographic",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                ca_bound$area_name, ca_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~ca_pal_demog(dim_2_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addLayersControl(
    baseGroups = c("Overall", "Social/Clinical", "Demographic"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  addLegend(pal = ca_pal_over, values = ca_bound@data$comb_score_rank, 
            labFormat = function(type, cuts, p) { 
              labels_map }) #custom palette

###############################################.
## UI ----
###############################################.
ui <- fluidPage(
  includeCSS("www/styles.css"),
   # Application title
   titlePanel("Vulnerability of communities to COVID-19"),
      sidebarPanel(
        radioGroupButtons("map_area", 
                          label= "Select a geography level", 
                          choices = c("Council area", "Intermediate zone",  "Data zone"), 
                          status = "primary", justified = TRUE, direction = "vertical"),
        savechart_button('download_mapplot', 'Save map', class= "down")
        # actionButton("browser", "Browser")
        ), #sidebar panel bracket
      mainPanel(
        withSpinner(leafletOutput("map_vuln", width="100%",height="550px"))
      )#mainpanel bracket
) #fulidpage bracket

###############################################.
## Server ----
###############################################.

server <- function(input, output) {
   
  # observeEvent(input$browser, browser())
  
   output$map_vuln <- renderLeaflet({

     if (input$map_area == "Data zone") {
       map_dz
     } else if (input$map_area == "Intermediate zone") {
       map_iz
     } else if (input$map_area == "Council area") {
       map_ca
     }
     
   })
   
   
   output$test <- renderText({print(input$map_vuln_id)})
   
   # Downloading the maps
   plot_map_download <- function(){

     if (input$map_area == "Data zone") {
       color_map <- case_when(input$map_vuln_groups == "Overall" ~
                                dz_pal_over(dz_bound@data$comb_score_rank),
                              input$map_vuln_groups == "Social/Clinical" ~
                                dz_pal_clinsoc(dz_bound@data$dim_1_rank),
                              input$map_vuln_groups == "Demographic" ~
                                dz_pal_demog(dz_bound@data$dim_2_rank))
       
       map_bound <- dz_bound
     } else if (input$map_area == "Intermediate zone") {
       color_map <- case_when(input$map_vuln_groups == "Overall" ~
                                iz_pal_over(iz_bound@data$comb_score_rank),
                              input$map_vuln_groups == "Social/Clinical" ~
                                iz_pal_clinsoc(iz_bound@data$dim_1_rank),
                              input$map_vuln_groups == "Demographic" ~
                                iz_pal_demog(iz_bound@data$dim_2_rank))
       
       map_bound <- iz_bound
     } else if (input$map_area == "Council area") {

       color_map <- case_when(input$map_vuln_groups == "Overall" ~
                                ca_pal_over(ca_bound@data$comb_score_rank),
                              input$map_vuln_groups == "Social/Clinical" ~
                                ca_pal_clinsoc(ca_bound@data$dim_1_rank),
                              input$map_vuln_groups == "Demographic" ~
                                ca_pal_demog(ca_bound@data$dim_2_rank))
  
       map_bound <- ca_bound

     }
     
     title_map <- paste0("Communities ", input$map_vuln_groups, " vulnerability to COVID-19")
     

     plot(map_bound, col=color_map)
     title(title_map, cex.main = 20,  line = -10) # adding title

   }
   
   
   #Donwloading map chart
   output$download_mapplot <- downloadHandler(
     filename = 'map.png',
     content = function(file){
       png(file, width = 6000, height = 6000, units = "px")
       plot_map_download()
       dev.off()
     })
   
} # server end

# Run the application 
shinyApp(ui = ui, server = server)

