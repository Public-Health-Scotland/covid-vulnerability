#
# This is a Shiny web application. You can run the application by clicking
# the 'Run App' button above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/
#

library(shiny)
library(leaflet)
library(shinyWidgets)
library(shinycssloaders)

###############################################.
## Preparing leaflet maps ----
###############################################.
# This needs to be done in the app as bug with leaflet
# see https://community.rstudio.com/t/leaflet-map-working-in-local-shiny-but-couldnt-normalize-path-error-on-shinyapps-io/35638
dz_bound <- readRDS("data/dz_bound.rds")
iz_bound <- readRDS("data/iz_bound.rds")
ca_bound <- readRDS("data/ca_bound.rds")


# labels
labels_map <- c("Least vulnerable", "", "", "", "Most vulnerable")
###############################################.
# DZ map 
dz_pal_over <- colorQuantile("YlOrRd", dz_bound@data$comb_score_rank, n = 5)
dz_pal_clinsoc <- colorQuantile("YlOrRd", dz_bound@data$dim_1_rank, n = 5)
dz_pal_demog <- colorQuantile("YlOrRd", dz_bound@data$dim_2_rank, n = 5)

map_dz <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data=dz_bound, group = "Overall",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                dz_bound$area_name, dz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~dz_pal_over(comb_score_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addPolygons(data=dz_bound, group = "Social/Clinical",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                dz_bound$area_name, dz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~dz_pal_clinsoc(dim_1_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)
  ) %>% 
  addPolygons(data=dz_bound, group = "Demographic",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                dz_bound$area_name, dz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~dz_pal_demog(dim_2_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addLayersControl(
    baseGroups = c("Overall", "Social/Clinical", "Demographic"),
    options = layersControlOptions(collapsed = FALSE)) %>% 
  addLegend(pal = dz_pal_over, values = dz_bound@data$comb_score_rank,  
            labFormat = function(type, cuts, p) { 
              labels_map }) #custom legend


###############################################.
# IZ map 

iz_pal_over <- colorQuantile("YlOrRd", iz_bound@data$comb_score_rank, n = 5)
iz_pal_clinsoc <- colorQuantile("YlOrRd", iz_bound@data$dim_1_rank, n = 5)
iz_pal_demog <- colorQuantile("YlOrRd", iz_bound@data$dim_2_rank, n = 5)

map_iz <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data=iz_bound, group = "Overall",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                iz_bound$area_name, iz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~iz_pal_over(comb_score_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addPolygons(data=iz_bound, group = "Social/Clinical",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                iz_bound$area_name, iz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~iz_pal_clinsoc(dim_1_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)
  ) %>% 
  addPolygons(data=iz_bound, group = "Demographic",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                iz_bound$area_name, iz_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~iz_pal_demog(dim_2_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addLayersControl(
    baseGroups = c("Overall", "Social/Clinical", "Demographic"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  addLegend(pal = iz_pal_over, values = iz_bound@data$comb_score_rank, 
            labFormat = function(type, cuts, p) { 
              labels_map }) #custom legend

###############################################.
# CA map 
ca_pal_over <- colorQuantile("YlOrRd", ca_bound@data$comb_score_rank, n = 5)
ca_pal_clinsoc <- colorQuantile("YlOrRd", ca_bound@data$dim_1_rank, n = 5)
ca_pal_demog <- colorQuantile("YlOrRd", ca_bound@data$dim_2_rank, n = 5)

map_ca <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data=ca_bound, group = "Overall",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                ca_bound$area_name, ca_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~ca_pal_over(comb_score_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addPolygons(data=ca_bound, group = "Social/Clinical",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                ca_bound$area_name, ca_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~ca_pal_clinsoc(dim_1_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)
  ) %>% 
  addPolygons(data=ca_bound, group = "Demographic",
              color = "#444444", weight = 1, smoothFactor = 0.5,
              #tooltip
              label = (sprintf(
                "<strong>%s%s</strong>",
                ca_bound$area_name, ca_bound$code) %>% lapply(htmltools::HTML)),
              opacity = 1.0, fillOpacity = 0.5, fillColor = ~ca_pal_demog(dim_2_rank),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% 
  addLayersControl(
    baseGroups = c("Overall", "Social/Clinical", "Demographic"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  addLegend(pal = ca_pal_over, values = ca_bound@data$comb_score_rank, 
            labFormat = function(type, cuts, p) { 
              labels_map }) #custom palette

###############################################.
## UI ----
###############################################.


# Define UI for application that draws a histogram
ui <- fluidPage(
  includeCSS("www/styles.css"),
  # Application title
  titlePanel("ScotPHO COVID-19 Community Combined Vulnerability Index"),
  p("In addition to clinical and public health responses to the Coronavirus (COVID-19) pandemic, action will
        be required to mitigate a range of associated social harms."),
  p("ScotPHO have created a community vulnerability measure based on demographic, social and clinical indicators relevant either directly to COVID-19 or to socio-economic factors that are likely to 
    modify the impacts of the pandemic and efforts to delay it."),
  sidebarPanel(
        radioGroupButtons("map_area", 
                          label= "Select a geography level", 
                          choices = c("Council area", "Intermediate zone",  "Data zone"), 
                          status = "primary", justified = TRUE, direction = "vertical")
        ), #sidebar panel bracket
      
      # Show a plot of the generated distribution
      mainPanel(
        withSpinner(leafletOutput("map_vuln", width="100%",height="550px"))
),#mainpanel bracket
p("Methodology", style = "font-weight: bold; color: black;"),
"The measures presented in this tool have been developed in response to COVID-19 and may be further refined over time.",br(),
p("ScotPHO have used data routinely available from the Health and Wellbeing Profile in the ",tags$a(href="https://scotland.shinyapps.io/ScotPHO_profiles_tool/","ScotPHO Online Profiles Tool",  class="externallink"),", with the exception of the Diabetes Patient Hospitalisation indicator. The indicators were chosen on the basis of being immediately available to the ScotPHO team; and were demographic or clinical indicators deemed to be directly relevant to COVID-19, clinical indicators relevant to other demands on clinical services or population health, or social factors that would be likely to modify the impact of COVID-19 on communities.  We used the most recent data in all cases (2016, 2017, 2018 or 2019)."),
p("We combined these indicators into a single measure for overall vulnerability across each of the three domains using an approach called principal components analysis (PCA)."), br(),
p("For more information contact: ",tags$b(tags$a(href="mailto:ScotPHO@nhs.net", "ScotPHO@nhs.net", class="externallink")))
) #fulidpage bracket

###############################################.
## Server ----
###############################################.

# Define server logic required to draw a histogram
server <- function(input, output) {
   
   output$map_vuln <- renderLeaflet({

     if (input$map_area == "Data zone") {
       map_dz
     } else if (input$map_area == "Intermediate zone") {
       map_iz
     } else if (input$map_area == "Council area") {
       map_ca
     }
     
   })
}

# Run the application 
shinyApp(ui = ui, server = server)

