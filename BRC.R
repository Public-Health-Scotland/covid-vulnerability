##British Red Cross

###############################################.
## Packages/Filepaths ----
###############################################.
library(dplyr)
library(readr)

if (sessionInfo()$platform %in% c("x86_64-redhat-linux-gnu (64-bit)", "x86_64-pc-linux-gnu (64-bit)")) {
  covid_folder <- "/PHI_conf/ScotPHO/Profiles/Projects/Covid vulnerability/"
} else {
  covid_folder<- "//stats/ScotPHO/Profiles/Projects/Covid vulnerability/"
}


###############################################.
## Functions ----
###############################################.
scale2 <-  function(x, na.rm = TRUE) (x - mean(x, na.rm = na.rm)) / sd(x, na.rm)

###############################################.
## Transforming data ----
###############################################.

optdata <- readRDS(paste0(covid_folder,"optdata.rds")) 

optdata <- optdata %>%
  mutate(areatype = case_when(substr(code,1,3) == "S01" ~ "Data zone", TRUE ~ paste0(areatype))) %>% 
  group_by(indicator, areatype, year) %>%
  mutate(rank_area=rank(measure),
         z_scores = scale2(rank_area)) %>%
  ungroup %>% 
  select(indicator, areatype, area_name, code, vulnerability, rank_area, z_scores)

write_csv(optdata, paste0(covid_folder, "brc_data.csv"))

##END

