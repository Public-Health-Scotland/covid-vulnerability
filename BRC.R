##British Red Cross

###############################################.
## Packages/Filepaths ----
###############################################.
library(dplyr)


# Varies filepaths depending on if using server or not and what organisation uses it.
if (exists("organisation") == TRUE) { #Health Scotland
  if (organisation == "HS") { 
    pop_lookup <- "X:/ScotPHO Profiles/Data/Lookups/Population/"
    geo_lookup <- "X:/ScotPHO Profiles/Data/Lookups/Geography/"
  }
} else  { #ISD, first server then desktop
  if (sessionInfo()$platform %in% c("x86_64-redhat-linux-gnu (64-bit)", "x86_64-pc-linux-gnu (64-bit)")) {
    covid_folder <- "/PHI_conf/ScotPHO/Profiles/Projects/Covid vulnerability/"
  } else {
    covid_folder<- "//stats/ScotPHO/Profiles/Projects/Covid vulnerability/"
  }
}



optdata <- readRDS(paste0(covid_folder,"optdata.rds")) 


optdata <- optdata %>%
  group_by(indicator, year, code) %>%
  mutate(rank=dense_rank(measure)) %>%
  ungroup




# function to calculate domain scores, ranks and deciles
calc_domain_scores = function(d, rank.indicators = TRUE) {
  if (rank.indicators) {
    d = d %>% 
      mutate_if(is.numeric, list(rank = rank))  # convert indicators to ranks
  }
  
  d %>% 
    # normalise the ranks so they're between 0 and 1
    mutate_at(vars(ends_with("rank")), list(scaled = scale_ranks)) %>% 
    
    # transform to an exponential distribution
    mutate_at(vars(ends_with("_scaled")), exp_transform) %>% 
    
    # combine with equal weights to get domain score
    mutate(`Vulnerability score` = reduce(select(., ends_with("_scaled")), `+`)) %>%   # source: https://stackoverflow.com/a/54527609
    
    # calculate domain ranks and deciles
    mutate(`Vulnerability rank` = rank(`Vulnerability score`)) %>% 
    mutate(`Vulnerability decile` = calc_risk_quantiles(`Vulnerability rank`, quants = 10)) %>%
    
    # keep only original indicators and domain vulnerability score/rank/decile
    select(-ends_with("_rank"), -ends_with("_scaled"))
}


