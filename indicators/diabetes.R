# Diabetes  hospitalisations
###############################################.
## Packages/Filepaths/Functions ----
###############################################.
source("1.indicator_analysis.R") #Normal indicator functions

channel <- suppressWarnings(dbConnect(odbc(),  dsn="SMRA",
                                      uid=.rs.askForPassword("SMRA Username:"), 
                                      pwd=.rs.askForPassword("SMRA Password:")))

###############################################.
## Part 1 - Extract data from SMRA ----
###############################################.
# Sorting variables
sort_var <- "link_no, admission_date, discharge_date, admission, discharge, uri"
diagnosis <- 'E1[01234]'

# Extracting admissions of patients with diabetes recorded in any position
diabetes <- tbl_df(dbGetQuery(channel, statement= paste0(
    "WITH adm_table AS (
        SELECT distinct link_no, cis_marker,
            FIRST_VALUE(DR_POSTCODE) OVER (PARTITION BY link_no, cis_marker 
                ORDER BY ", sort_var, ") pc7,
            FIRST_VALUE(sex) OVER (PARTITION BY link_no, cis_marker 
                ORDER BY ", sort_var, ") sex_grp,
            MIN(age_in_years) OVER (PARTITION BY link_no, cis_marker) age, 
            MIN(admission_date) OVER (PARTITION BY link_no, cis_marker) start_cis
        FROM ANALYSIS.SMR01_PI  z
        WHERE exists(
          SELECT * 
          FROM ANALYSIS.SMR01_PI  
          WHERE link_no=z.link_no and cis_marker=z.cis_marker
              AND (regexp_like(main_condition, '", diagnosis, "')
                  OR regexp_like(other_condition_1, '", diagnosis, "')
                  OR regexp_like(other_condition_2, '", diagnosis, "')
                  OR regexp_like(other_condition_3, '", diagnosis, "')
                  OR regexp_like(other_condition_4, '", diagnosis, "')
                  OR regexp_like(other_condition_5, '", diagnosis, "'))
        )
    )
    SELECT link_no, cis_marker, sex_grp, age, pc7,
           CASE WHEN extract(month from start_cis) > 3 
                THEN extract(year from start_cis) 
                ELSE extract(year from start_cis) -1 END as year 
    FROM adm_table 
    WHERE start_cis between '1 April 2016' and '31 March 2019'
        AND sex_grp in ('1', '2') "))) %>% 
  setNames(tolower(names(.))) %>% 
  create_agegroups()

postcode_lookup <- readRDS('/conf/linkage/output/lookups/Unicode/Geography/Scottish Postcode Directory/Scottish_Postcode_Directory_2019_2.rds') %>%
  setNames(tolower(names(.))) %>%  #variables to lower case
  select(pc7, datazone2011)

# Match geography information (datazone) to stays data
diabetes <- left_join(diabetes, postcode_lookup, "pc7") %>%
  subset(!(is.na(datazone2011)))  #select out non-scottish

diabetes <- diabetes %>% group_by(year, datazone2011, sex_grp, age_grp) %>%  
  summarize(numerator = n()) %>% ungroup() %>%  rename(datazone = datazone2011)

saveRDS(diabetes, file=paste0(data_folder, 'Prepared Data/diabetes_dz11_raw.rds'))

###############################################.
## Part 3 - Run analysis functions ----
###############################################.

# Doing five year aggregation
analyze_first(filename = "diabetes_dz11", geography = "datazone11", measure = "stdrate", 
              pop = "DZ11_pop_allages", yearstart = 2016, yearend = 2018,
              time_agg = 3, epop_age = "normal")

analyze_second(filename = "diabetes_dz11", measure = "stdrate", time_agg = 3, 
               epop_total = 200000, ind_id = 1001, year_type = "financial")

final_result <- final_result %>% filter(substr(code, 1, 3) == "S01")

hist(final_result$numerator)

##END