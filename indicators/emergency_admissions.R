# Emergency admissions and multiple emergency admissions(+65). 
# Parts 1 and 2 take about ~20 minutes to run

#   Part 1 - Extract data from SMRA
#   Part 2 - Create the different geographies basefiles
#   Part 3 - Run analysis functions


###############################################.
## Packages/Filepaths/Functions ----
###############################################.
source("1.indicator_analysis.R") #Normal indicator functions

#Function to create data for different geography levels
create_geo_levels <- function(geography, list_pos) {
  #If there are multiple admissions in one year it selects one.
  data_agg <- data_adm %>% rename(code = {{geography}} ) %>% 
    group_by(link_no, year, code) %>% 
    summarise(sex_grp = first(sex_grp), age_grp = first(age_grp), admissions = n()) %>%
    ungroup()
  
  #And now it aggregates total count of patients.
  data_ea <- data_agg %>% group_by(year, code, sex_grp, age_grp) %>% 
    count() %>% ungroup() %>% rename(numerator = n)
  
  data_ea_list[[list_pos]] <<- data_ea #assigning to list
  
  #select only patients who have had 2 or more admissions and 65+.
  data_ma <- data_agg %>% 
    filter(age_grp >= 14 & admissions >= 2 ) %>% 
    group_by(year, code, sex_grp, age_grp) %>% 
    count() %>% ungroup() %>% rename(numerator = n)
  
  data_ma_list[[list_pos]] <<- data_ma #assigning to list
  
}

###############################################.
## Part 2 - Create the different geographies basefiles ----
###############################################.
data_adm <- readRDS('/PHI_conf/ScotPHO/Profiles/Data/Prepared Data/smr01_emergency_basefile.rds')

#creating file for emergency admissions and multiple admissions
data_ea_list <- list() #creating empty lists for placing data created by function
data_ma_list <- list() 

# This will run the function for all those columns and for both indicators
mapply(create_geo_levels, geography = c("ca2019",  "intzone2011", "datazone2011"), 
       list_pos = 1:3)

data_ea <- do.call("rbind", data_ea_list) # converting from list into dataframe
data_ma <- do.call("rbind", data_ma_list) # converting from list into dataframe

saveRDS(data_ea, paste0(data_folder, 'Prepared Data/ea_raw.rds'))
saveRDS(data_ma, paste0(data_folder, 'Prepared Data/ma_raw.rds'))

###############################################.
## Part 3 - Run analysis functions ----
###############################################.
# The function call uses a different geogrpahy to datazone11 or council as this way,
# it skips the parts of the function that bring the geographical info.
mapply(analyze_first, filename = c("ea", "ma"), geography = "all", measure = "stdrate", 
       pop = c("DZ11_pop_allages", "DZ11_pop_65+"), yearstart = 2014, yearend = 2018,
       time_agg = 5, epop_age = "normal", hscp = T)

#Emergency admissions
analyze_second(filename = "ea", measure = "stdrate", time_agg = 5, 
               epop_total = 200000, ind_id = 20305, year_type = "calendar")

#Multiple emergency admissions for 65+
analyze_second(filename = "ma", measure = "stdrate", time_agg = 5, 
               epop_total = 39000, ind_id = 20306, year_type = "calendar")

##END

