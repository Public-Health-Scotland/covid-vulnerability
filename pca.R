##########################################################.
## Packages ----
##########################################################.
library(tidyverse)
library(FactoMineR)
library(factoextra)
library(corrplot)

##########################################################.
## Data ----
##########################################################.
mainDir <- "//hssynnas02/team-pho/ScotPHO Profiles/Projects/Covid vulnerability"
subDir <- "Output"

setwd(file.path(mainDir))

optdata <- readRDS("Prepared data/optdata.RDS")
#table(optdata$areatype)
#table(optdata$indicator)
#table(optdata$year)

optdata2 <- optdata %>%
  select(code, indicator, measure)
#table(optdata2$indicator)

optdata3 <- optdata2 %>%
  pivot_wider(id_cols=code, names_from = indicator, values_from = measure) %>%
  select(code, 
         incdep= "Population income deprived",
         singdwell= "Single adult dwellings",                                                   
         empdep= "Working age population employment deprived",              
         pop65plus= "Mid-year population estimate - aged 65+ years",                            
         pop75plus= "Mid-year population estimate - aged 75+ years",                            
         pop85plus= "Mid-year population estimate - aged 85+ years",                             
         alchosp="Alcohol-related hospital admissions",                                                     
         asthmahosp= "Asthma patient hospitalisations",                          
         chdhosp= "Coronary heart disease (CHD) patient hospitalisations",
         copdhosp="Chronic obstructive pulmonary disease (COPD) patient hospitalisations",               
         deaths= "Deaths all ages",                                       
         death1544= "Deaths, aged 15-44 years",                                                                
         cancer75="Early deaths from cancer, aged <75 years",                                                
         chd75="Early deaths from coronary heart disease (CHD), aged <75 years",                       
         emerghosp= "Emergency patient hospitalisations",                         
         multiemerg= "Multiple emergency hospital admissions, aged >65 years",
         childlowinc="Children in low income families",                                          
         lifeexpf="Life expectancy, females",                                                 
         lifeexpm="Life expectancy, males",  
         asthmahosp="Asthma patient hospitalisations",                                          
        cancerreg="Cancer registrations",                                                    
        childprot="Children on the child protection register",
        diabhosp="Diabetes hospitalisations",
        drughosp="Drug-related hospital admissions",
        childfuelpov="Households with children living in fuel poverty",
        careathome="People aged 65+ with high levels of care needs who are cared for at home",
        menthealthdrugs="Population prescribed drugs for anxiety/depression/psychosis",            
        psychhosp="Psychiatric patient hospitalisations",
        schmeals="Children registered for free school meals")  %>%
  mutate(areatype=substr(code, 1, 3))
#table(optdata3$areatype)

optdata3_dz <- optdata3 %>%
  filter(areatype=="S01") %>%
  select(-areatype, -starts_with("lifeexp"), -childfuelpov, -careathome, -schmeals, -childprot) %>% #remove vars with no data
  mutate_if(is.numeric, ~replace(., is.infinite(.), NA)) %>% #some Inf values in empdep and incdep
  column_to_rownames(var="code")

optdata3_iz <- optdata3 %>%
  filter(areatype=="S02") %>%
  column_to_rownames(var="code") %>%
  select(-areatype, -starts_with("lifeexp"), -childfuelpov, -careathome, -schmeals, -childprot) #remove vars with no data

optdata3_ca <- optdata3 %>%
  filter(areatype=="S12") %>%
  column_to_rownames(var="code") %>%
  select(-areatype) 

##########################################################.
## PCA for datazone data ----
##########################################################.
setwd(file.path(mainDir, subDir))

optdata3_dz.pca <- PCA(optdata3_dz, scale.unit = TRUE, ncp = 5, graph = TRUE)

#export the plot
dev.copy(png,'dz_pca_indicator_plot.png')
dev.off()

print(optdata3_dz.pca)

#Extract the eigenvalues/variances of principal components
eig.val <- get_eigenvalue(optdata3_dz.pca) 
write.csv(eig.val, "dz_pca_eigenvalues.csv")

#Extract the results for the areas
inds <- get_pca_ind(optdata3_dz.pca)
dz_coords <- data.frame(inds$coord)
write.csv(dz_coords, "dz_pca_coordinates.csv")

#Extract the results for the variables
vars <- get_pca_var(optdata3_dz.pca) 
#The contribution of a variable (var) to a given principal component is (in percentage) : (var.cos2 * 100) / (total cos2 of the component).
contributions <- vars$contrib
write.csv(contributions, "dz_pca_indicator_contributions.csv")

#Visualize and export the results for individuals.
fviz_pca_ind(optdata3_dz.pca)
dev.copy(png,'dz_pca_individual_area_plot.png')
dev.off()

##########################################################.
## PCA for IZ data ----
##########################################################.

optdata3_iz.pca <- PCA(optdata3_iz, scale.unit = TRUE, ncp = 5, graph = TRUE)

#export the plot
dev.copy(png,'iz_pca_indicator_plot.png')
dev.off()

print(optdata3_iz.pca)

#Extract the eigenvalues/variances of principal components
eig.val <- get_eigenvalue(optdata3_iz.pca) 
eig.val
write.csv(eig.val, "iz_pca_eigenvalues.csv")

#Extract the results for the areas
inds <- get_pca_ind(optdata3_iz.pca)
iz_coords <- data.frame(inds$coord)
write.csv(iz_coords, "iz_pca_coordinates.csv")

#Extract the results for the variables
vars <- get_pca_var(optdata3_iz.pca) 
#The contribution of a variable (var) to a given principal component is (in percentage) : (var.cos2 * 100) / (total cos2 of the component).
contributions <- vars$contrib
write.csv(contributions, "iz_pca_indicator_contributions.csv")

#Visualize and export the results for individuals.
fviz_pca_ind(optdata3_iz.pca)
dev.copy(png,'iz_pca_individual_area_plot.png')
dev.off()

##########################################################.
## PCA for council area data ----
##########################################################.

optdata3_ca.pca <- PCA(optdata3_ca, scale.unit = TRUE, ncp = 5, graph = TRUE)

#export the plot
dev.copy(png,'ca_pca_indicator_plot.png')
dev.off()

print(optdata3_ca.pca)

#Extract the eigenvalues/variances of principal components
eig.val <- get_eigenvalue(optdata3_ca.pca) 
write.csv(eig.val, "ca_pca_eigenvalues.csv")

#Extract the results for the areas
inds <- get_pca_ind(optdata3_ca.pca)
ca_coords <- data.frame(inds$coord)
write.csv(ca_coords, "ca_pca_coordinates.csv")

#Extract the results for the variables
vars <- get_pca_var(optdata3_ca.pca) 
#The contribution of a variable (var) to a given principal component is (in percentage) : (var.cos2 * 100) / (total cos2 of the component).
contributions <- vars$contrib
write.csv(contributions, "ca_pca_indicator_contributions.csv")

#Visualize and export the results for individuals.
fviz_pca_ind(optdata3_ca.pca)
dev.copy(png,'ca_pca_individual_area_plot.png')
dev.off()

#END

