# Code to create a population lookup files for the Profiles. 
# The file first creates some basefiles to then run a series of macros to get the lookups with the desired population

# Part 1 - Functions.
# Part 2 - Basefiles based on DZ01 and DZ11
# Part 3 - Basefiles by deprivation quintile
# Part 4 - Create population files 

###############################################.
## Packages/Filepaths ----
###############################################.
library(dplyr)
library(tidyr) # long to wide format
library(httr) # api connection
library(jsonlite)  # transforming JSON files into dataframes

# Varies filepaths depending on if using server or not and what organisation uses it.
if (exists("organisation") == TRUE) { #Health Scotland
  if (organisation == "HS") { 
    pop_lookup <- "X:/ScotPHO Profiles/Data/Lookups/Population/"
    geo_lookup <- "X:/ScotPHO Profiles/Data/Lookups/Geography/"
  }
} else  { #ISD, first server then desktop
  if (sessionInfo()$platform %in% c("x86_64-redhat-linux-gnu (64-bit)", "x86_64-pc-linux-gnu (64-bit)")) {
    pop_lookup <- "/PHI_conf/ScotPHO/Profiles/Data/Lookups/Population/"
    geo_lookup <- "/PHI_conf/ScotPHO/Profiles/Data/Lookups/Geography/"
    covid_lookups <- "/PHI_conf/ScotPHO/Profiles/Projects/Covid vulnerability/Lookups/"
  } else {
    pop_lookup <- "//stats/ScotPHO/Profiles/Data/Lookups/Population/"
    geo_lookup <- "//stats/ScotPHO/Profiles/Data/Lookups/Geography/"
    covid_lookups <- "//stats/ScotPHO/Profiles/Projects/Covid vulnerability/Lookups/"
  }
}

###############################################.
## Part 1 - Functions ----
###############################################.
#Function to create age groups needed for standardization
create_agegroups <- function(df) {
  df <- df %>% mutate(age_grp = case_when( 
    age < 5 ~ 1, age > 4 & age <10 ~ 2, age > 9 & age <15 ~ 3, age > 14 & age <20 ~ 4,
    age > 19 & age <25 ~ 5, age > 24 & age <30 ~ 6, age > 29 & age <35 ~ 7, 
    age > 34 & age <40 ~ 8, age > 39 & age <45 ~ 9, age > 44 & age <50 ~ 10,
    age > 49 & age <55 ~ 11, age > 54 & age <60 ~ 12, age > 59 & age <65 ~ 13, 
    age > 64 & age <70 ~ 14, age > 69 & age <75 ~ 15, age > 74 & age <80 ~ 16,
    age > 79 & age <85 ~ 17, age > 84 & age <90 ~ 18, age > 89 ~ 19, 
    TRUE ~ as.numeric(age)
  ))
}

###############################################.
# This function extract the data for each geographical level from the NHS data platform
# and then formats it in the way is neeeded. It uses two parameters, one for the 
# resource-id used in the plaform and one for the name of the geography variable for that data
extract_open_data <- function(resource_id, geography) {
  
  # URL used for data extraction
  open_data_url <- "https://www.opendata.nhs.scot/api/3/action/datastore_search?resource_id="
  
  # After finding out the length of the file we can extract the whole thing
  # Limit is set to 1 million, check nothing is bigger than that
  data_extraction <-  GET(paste0(open_data_url, resource_id, "&limit=1000000"))
  # Checking if request has worked
  print(paste0("A value of 200 means the server has received the request:", data_extraction$status_code))
  # It's a JSON file, so transforming into something more usable in R
  data_extraction <- rawToChar(data_extraction$content) %>% fromJSON()
  data_extraction <- data_extraction$result$records %>% #extracting data  
    setNames(tolower(names(.)))   #variables to lower case
  
  # Formatting the data in the way needed
  data_extraction <- data_extraction %>%
    filter(year > 2001 & substr({{geography}}, 1, 3) != "S92") %>% #years and no Scotland
    mutate(sex = recode(sex, "Male" = 1, "Female" = 2)) %>%
    select(year, sex, {{geography}}, age0:age90plus) %>%
    gather(age, pop, -c(year, sex, {{geography}})) %>% #wide to long format
    mutate(age = as.numeric(gsub("age|plus", "", age))) %>% #recoding age variable
    rename(code = {{geography}}, sex_grp = sex)
  
}

###############################################.
# This functions takes a basefile (DZ11), selects the age of interest and
# produces files for % and crude rates and for standard rates. It also allows you
# to create files only with council and higher geographies.
# Lower and upper are the age limits, name is the name of the output file,
# dx is what datazone you are using, council if you want council files and
# stdrate if you want pops used  for standarized rates
create_pop <- function(lower, upper, name, dz) {
  
  ###############################################.
  # Creating files for percentages crude rates 
  #Reading file, aggregating and saving file for % and crude rates
  data_dz <- readRDS(file=paste0(covid_lookups, "basefile_covid_DZ11.rds")) %>% 
    subset(age >= lower & age <= upper) #selecting age of interest
  
  data_dz_nonsr <- data_dz %>% group_by(year, code) %>% summarise(denominator=sum(denominator)) %>% ungroup()

  saveRDS(data_dz_nonsr, file=paste0(covid_lookups, dz, '_', name,'.rds'))
  
   # Creating file for indicators that need council as base
    data_ca <- data_dz_nonsr %>% subset(substr(code,1,3) %in% c('S00', 'S08', 'S12', "S37"))
    
    saveRDS(data_ca, file=paste0(covid_lookups, 'CA_', name,'.rds'))
  
    rm(data_dz_nonsr)
  ###############################################.
  # Creating files for standardized rates
    data_dz_sr <- data_dz %>% 
      group_by(year, code, sex_grp, age_grp) %>% #aggregating
      summarise(denominator=sum(denominator)) %>% ungroup()
    
    saveRDS(data_dz_sr, file=paste0(covid_lookups, dz, '_', name,'_SR.rds'))
    
    # Creating file for indicators that need council as base
    data_ca_sr <- data_dz_sr %>% subset(substr(code,1,3) %in%  c('S00', 'S08', 'S12',  "S37"))
      
      saveRDS(data_ca_sr, file=paste0(covid_lookups, 'CA_', name,'_SR.rds'))
      
}

###############################################.
## Part 2 - Basefiles based on DZ11 ----
###############################################.
dz11_base <- readRDS(paste0(pop_lookup, "DZ11_pop_basefile.rds")) %>% 
  rename(pop = denominator, code =datazone2011) %>% select(-age_grp)

###############################################.
# Intermediate zones, councils, health boards and HSC partnerships
# Resource ids can be accessed in the page for the estimate pops here:
# https://www.opendata.nhs.scot/dataset/population-estimates
hscp_pop <- extract_open_data("c3a393ce-253b-4c75-82dc-06b1bb5638a3", hscp2016) 
ca_pop <- extract_open_data("09ebfefb-33f4-4f6a-8312-2d14e2b02ace", ca2011) 
iz11_pop <- extract_open_data("93df4c88-f74b-4630-abd8-459a19b12f47", iz2011) 

###############################################.
#Scotland population
scot_pop <- ca_pop %>% group_by(year, sex_grp, age) %>% 
  summarise(pop = sum(pop)) %>% ungroup() %>% mutate(code = "S00000001")

###############################################.
#HSC locality population
loc_lookup <- readRDS(paste0(geo_lookup, "DataZone11_All_Geographies_Lookup.rds")) %>% 
  select(datazone2011, hscp_locality) %>% rename(code = hscp_locality) 

#Merging with locality lookup
local_pop <- left_join(dz11_base, loc_lookup, c("datazone2011")) %>% 
  select(-datazone2011, age_grp) %>% group_by(year, sex_grp, age, code) %>% 
  summarise(pop = sum(denominator)) %>% ungroup()


###############################################.
#merging all geographical levels

dz11_base <- rbind(dz11_base, iz11_pop, ca_pop, hscp_pop, scot_pop, local_pop) %>% 
  rename(denominator=pop) %>% create_agegroups() %>%  #recoding age
  mutate(year = as.numeric(year))

saveRDS(dz11_base, file= paste0(covid_lookups, "basefile_covid_DZ11.rds"))

###############################################.
## Part 4 - Create population files  ----
###############################################.
# DZ11, LA and deprivation
create_pop(dz = "DZ11", lower = 0, upper = 200, name = "pop_allages")
create_pop(dz = "DZ11", lower = 65, upper = 200, name = "pop_65+")
create_pop(dz = "DZ11", lower = 75, upper = 200, name = "pop_75+")
create_pop(dz = "DZ11", lower = 85, upper = 200, name = "pop_85+")

###############################################.
# Working age population
working_pop <- readRDS(file=paste0(covid_lookups, "basefile_covid_DZ11.rds")) %>% 
  subset(age > 15 & age < 65 & sex_grp ==1 | #selecting age of interest
         sex_grp==2 & age>15 & age<65 & year>2009 | 
           sex_grp==2 & age>15 & age<60 & year<2010) %>% 
  group_by(year, code) %>% summarise(denominator=sum(denominator)) %>% ungroup()

saveRDS(working_pop, file=paste0(covid_lookups, 'DZ11_working_pop.rds'))


##END
