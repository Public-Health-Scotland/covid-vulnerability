# Excel workbook of vulnerability


###############################################.
## Packages/Filepaths/Functions ----
###############################################.

library(readr)
library(dplyr) # for data manipulation
library(janitor)


source("1.indicator_analysis.R") #Normal indicator functions


###############################################.
## Read in lookups ----
###############################################.

# Lookup for matching geography codes to names 
all_geo_lookup <- read_csv(paste0(covid_lookups, "All Geography Names Lookup.csv")) #iz and council 
dz_geo_lookup <- read_csv(paste0(covid_lookups, "dz to geogrpahy lookup.csv")) #dz

# Addition of populations at DZ level
dz_pop <- read_csv(paste0(covid_lookups, "dzpop.csv"))

# Matching to parent geographies
iz <- read_csv(paste0(covid_lookups, "iz to parent lookup.csv"))



###############################################.
## Council Area ----
###############################################.


ca_pca <- read_csv(paste0(data_folder, "pca results/ca_pca_coordinates.csv")) %>% 
  janitor::clean_names() %>% 
  rename(code = x1) %>% 
  mutate(dim_1_norm = as.vector(scales::rescale(dim_1, to=c(0,1))),
         dim_2_norm = as.vector(scales::rescale(dim_2, to=c(0,1))),
         comb_score = dim_1_norm +dim_2_norm,
         dim_1_rank = dense_rank(dim_1),
         dim_2_rank = dense_rank(dim_2),
         comb_score_rank = dense_rank(comb_score)) %>% 
  select(code, dim_1, dim_2, comb_score, dim_1_rank, dim_2_rank, comb_score_rank)


ca_pca1 <- left_join(x=ca_pca, y=all_geo_lookup, by=c("code"="area_code"))
  
ca_pca1 <- ca_pca1 %>%
  mutate(p_rank_score=percent_rank(comb_score),
         quintile_score=ntile(comb_score,5),
         p_rank_rank=percent_rank(comb_score_rank),
         quintile_rank=ntile(comb_score_rank,5))


