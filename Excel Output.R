# Excel workbook of vulnerability


###############################################.
## Packages/Filepaths/Functions ----
###############################################.

library(readr)
library(dplyr) # for data manipulation
library(janitor)


source("1.indicator_analysis.R") #Normal indicator functions


###############################################.
## Read in lookups ----
###############################################.

# Lookup for matching geography codes to names 
all_geo_lookup <- read_csv(paste0(covid_lookups, "All Geography Names Lookup.csv")) #iz and council 
dz_geo_lookup <- read_csv(paste0(covid_lookups, "dz to geogrpahy lookup.csv")) #dz

# Create IZ lookup detailing names and parent geographies
iz_to_parent <- dz_geo_lookup %>%
  select (intzone2011,ca2019) %>%
  group_by(intzone2011,ca2019) %>%
  summarise(count=n()) %>%
  select(-count) %>%
  rename(parent_ca=ca2019, code=intzone2011)

iz_to_parent <- left_join(x=iz_to_parent, y=all_geo_lookup, by=c("parent_ca"="area_code")) %>%
  rename(parent_ca_name=area_name) %>%
  select(-area_type)

iz_to_parent  <- left_join(x=iz_to_parent, y=all_geo_lookup, by=c("code"="area_code"))


# Create 2018 population files for dz,iz,ca 
dz_pop <- read_csv(paste0(covid_lookups, "dzpop.csv"))
pop_lookup <- left_join(x=dz_pop, y=dz_geo_lookup, by=c("code"="datazone2011"))

dz_pop <- pop_lookup %>%
  group_by(intzone2011) %>%
  summarise(population=sum(pop))

iz_pop <- pop_lookup %>%
  group_by(intzone2011) %>%
  summarise(population=sum(pop))

ca_pop <- pop_lookup %>%
  group_by(ca2019) %>%
  summarise(population=sum(pop))

###############################################.
## Council Area ----
###############################################.
#open council data file 
ca_pca <- read_csv(paste0(data_folder, "pca results/ca_pca_coordinates.csv")) %>% 
  janitor::clean_names() %>% 
  rename(code = x1) %>% 
  mutate(dim_1_norm = as.vector(scales::rescale(dim_1, to=c(0,1))),
         dim_2_norm = as.vector(scales::rescale(dim_2, to=c(0,1))),
         comb_score = dim_1_norm +dim_2_norm,
         dim_1_rank = dense_rank(dim_1),
         dim_2_rank = dense_rank(dim_2),
         comb_score_rank = dense_rank(comb_score)) %>% 
  select(code, dim_1, dim_2, comb_score, dim_1_rank, dim_2_rank, comb_score_rank)

#match on geography name info
ca_pca1 <- left_join(x=ca_pca, y=all_geo_lookup, by=c("code"="area_code"))
  
#calculate quintile
ca_pca1 <- ca_pca1 %>%
  mutate(p_rank_score=percent_rank(comb_score), #percentile rank based on combined score
         quintile_score=ntile(comb_score,5), #quintile based on score
         p_rank_rank=percent_rank(comb_score_rank),#percentile rank based on combined score rank
         quintile=ntile(comb_score_rank,5)) #quintile based on score

#match on council populations
ca_pca1 <- left_join(x=ca_pca1, y=ca_pop, by=c("code"="ca2019")) 

#format final file
ca_pca1 <- ca_pca1 %>%
  select(area_name,code:comb_score_rank,quintile, area_type,population)
  
write_csv(ca_pca_final, paste0(data_folder, "pca results/ca_pca_final.csv"))

###############################################.
## IZ ----
###############################################.

iz_pca <- read_csv(paste0(data_folder, "pca results/iz_pca_coordinates.csv")) %>% 
  janitor::clean_names() %>% 
  rename(code = x1) %>% 
  mutate(dim_1_norm = as.vector(scales::rescale(dim_1, to=c(0,1))),
         dim_2_norm = as.vector(scales::rescale(dim_2, to=c(0,1))),
         comb_score = dim_1_norm +dim_2_norm,
         dim_1_rank = dense_rank(dim_1),
         dim_2_rank = dense_rank(dim_2),
         comb_score_rank = dense_rank(comb_score)) %>% 
  select(code, dim_1, dim_2, comb_score, dim_1_rank, dim_2_rank, comb_score_rank)

iz_pca1 <- left_join(x=iz_pca, y=iz_to_parent, by=c("code"="code"))

iz_pca1 <- iz_pca1 %>%
  mutate(p_rank_score=percent_rank(comb_score),
         quintile_score=ntile(comb_score,5),
         p_rank_rank=percent_rank(comb_score_rank),
         quintile=ntile(comb_score_rank,5))

#match on council populations
iz_pca1 <- left_join(x=iz_pca1, y=iz_pop, by=c("code"="intzone2011")) 

#format final file
iz_pca1 <- iz_pca1 %>%
  select(area_name,code:comb_score_rank,quintile,area_type,parent_ca,parent_ca_name,population)

write_csv(iz_pca1, paste0(data_folder, "pca results/iz_pca_final.csv"))



###############################################.
## DZ ----
###############################################.


