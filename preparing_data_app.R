# Preparing data for Shiny app

###############################################.
## Packages/Filepaths/Functions ----
###############################################.
library(rgdal) #for reading shapefiles
library(rgeos) #for reducing size of shapefiles
library(rmapshaper)
library(readr)

if (sessionInfo()$platform %in% c("x86_64-redhat-linux-gnu (64-bit)", "x86_64-pc-linux-gnu (64-bit)")) {
  shapefiles <- "/PHI_conf/ScotPHO/Profiles/Data/Shapefiles/"
} else  {
  shapefiles <- "//stats/ScotPHO/Profiles/Data/Shapefiles/"
}
source("1.indicator_analysis.R") #Normal indicator functions

###############################################.
## Technical document ----
###############################################.
#This code updates the Technical Document table based on an online Google Drive version of the table
#Run every time you want to refresh the data in the local copy to represent what's in the online copy
#This file is where indicator names and definitions are stored and are loaded into the shiny tool.
ind_lookup <- gsheet::gsheet2tbl("docs.google.com/spreadsheets/d/1JOr1_MSnKdQfg4o8qEiqX-EKDsbXUjejnAV4NzbSg78#gid=2036303524") %>%
  setNames(tolower(names(.))) %>% #variables to lower case
  mutate(ind_id =as.numeric(ind_id)) %>%
  mutate_if(is.character, factor)  # converting variables into factors

diabetes <- data.frame(ind_id = 1001, indicator = "Diabetes hospitalisations")

ind_lookup <- bind_rows(ind_lookup, diabetes)

geo_lookup <- readRDS("/PHI_conf/ScotPHO/1.Analysts_space/Jaime/profiles-tool/data/geo_lookup.rds")
load("area_name_lookup.rda")


###############################################.
## Get PCA data ----
###############################################.
ca_pca <- readRDS(paste0(data_folder, "pca results/ca_pca_final.rds"))
iz_pca <- readRDS(paste0(data_folder, "pca results/iz_pca_final.rds"))
dz_pca <- readRDS(paste0(data_folder, "pca results/dz_pca_final.rds"))

###############################################.
## Prepare or load shapefiles ----
###############################################.
iz_bound <- readRDS(paste0(shapefiles, "IZ_boundary.rds"))

iz_bound <- iz_bound %>% rmapshaper::ms_simplify(keep=0.050, keep_shapes = T)
saveRDS(iz_bound, "iz_boundary.rds")
iz_bound <- readRDS( "iz_boundary.rds")

iz_bound <- sp::merge(iz_bound, iz_pca, by='code')

names(iz_bound@data)[names(iz_bound@data)=="area_name.x"] <- "area_name"

saveRDS(iz_bound, "maps_app/data/iz_bound.rds")

#CA
ca_bound <- readRDS(paste0(shapefiles, "CA_boundary.rds"))
ca_bound <- sp::merge(ca_bound, ca_pca, by='code')

names(ca_bound@data)[names(ca_bound@data)=="area_name.x"] <- "area_name"

saveRDS(ca_bound, "maps_app/data/ca_bound.rds")

#DZ
dz11_shp <-readOGR('/conf/linkage/output/lookups/Unicode/Geography/Shapefiles/Data Zones 2011/',
                   "SG_DataZone_Bdry_2011") %>%
  setNames(tolower(names(.))) #variables to lower case

dz11_shp <- dz11_shp %>% rmapshaper::ms_simplify(keep=0.0050, keep_shapes = T)

# Transforming projection
dz11_shp <- spTransform(dz11_shp,  CRS("+ellps=WGS84 +proj=longlat +datum=WGS84 +no_defs"))

names(dz11_shp@data)[names(dz11_shp@data)=="datazone"] <- "code"
names(dz11_shp@data)[names(dz11_shp@data)=="name"] <- "area_name"

saveRDS(dz11_shp, paste0(shapefiles, "Datazone2011_boundary.rds"))

dz_bound <- readRDS(paste0(shapefiles, "Datazone2011_boundary.rds"))
dz_bound <- sp::merge(dz_bound, dz_pca, by='code')

names(dz_bound@data)[names(dz_bound@data)=="area_name.x"] <- "area_name"

saveRDS(dz_bound, "maps_app/data/dz_bound.rds")

###############################################.
## Putting together data ----
###############################################.

#Finds all the csv files in the shiny folder
files <-  list.files(path = paste0(data_folder, "Output/"), pattern = "*.rds", full.names = TRUE)

# reads the data and combines it, variables to lower case and variable with filename
optdata <- do.call(rbind, lapply(files, function(x){
  readRDS(x) })) %>% 
  rename(measure = rate) %>%
  mutate_at(c("numerator", "measure", "lowci", "upci"), as.numeric) %>%
  mutate(ind_id = as.integer(ind_id)) %>% 
  filter(substr(code,1,3) %in% c("S01", "S02", "S12")) #only these geos

optdata <- left_join(x=optdata, y=ind_lookup, by="ind_id")
# if for some reason some indicators haven't matched with the lookup this will show them
View(optdata %>% filter(is.na(indicator)))

optdata <- left_join(x=optdata, y=area_name_lookup, by=c("code" = "geo_code"))

optdata <- optdata %>% 
  select(-c(ind_id, lowci, upci, def_period, type_id, supression, supress_less_than,
            profile_domain1, profile_domain2, label_ineq))

optdata <- optdata %>% 
  mutate(areatype = case_when(substr(code, 1, 3) == "S00" ~ "Scotland",
                              substr(code, 1, 3) == "S08" ~ "Health board",
                              substr(code, 1, 3) == "S12" ~ "Council area",
                              substr(code, 1, 3) == "S11" ~ "Alcohol & drug partnership",
                              substr(code, 1, 3) == "S99" ~ "HSC locality",
                              substr(code, 1, 3) == "S37" ~ "HSC partnership",
                              substr(code, 1, 3) == "S02" ~ "Intermediate zone")) %>% 
  #Dealing with changes in ca, hb and hscp codes. Transforms old code versions into 2019 ones
  mutate(code = recode(code, "S12000015"='S12000047', "S12000024"='S12000048',
                       "S12000046"='S12000049', "S12000044"='S12000050',
                       "S08000018"='S08000029', "S08000027"= 'S08000030',
                       "S08000021"='S08000031', "S08000023"= 'S08000032',
                       "S37000014"='S37000032', "S37000023"='S37000033',
                       "S37000015"='S37000034', "S37000021"='S37000035')) %>% 
  mutate(vulnerability = recode(indicator, "Alcohol-related hospital admissions" = "Clinical", 
                                             "Asthma patient hospitalisations"= "Clinical", 
                                             "Cancer registrations"= "Clinical", 
                                             "Children on the child protection register"= "Social", 
                                             "Children in low income families"= "Social", 
                                             "Chronic obstructive pulmonary disease (COPD) patient hospitalisations" = "Clinical", 
                                             "Deaths, aged 15-44 years"= "Clinical", 
                                             "Deaths all ages"= "Clinical", 
                                "Early deaths from coronary heart disease (CHD), aged <75 years"= "Clinical", 
                                "Diabetes hospitalisations"= "Clinical", 
                                "Drug-related hospital admissions"= "Clinical", 
                                "Emergency patient hospitalisations"= "Clinical", 
                                "Early deaths from cancer, aged <75 years"= "Clinical", 
                                "Households with children living in fuel poverty"= "Social", 
                                "People aged 65+ with high levels of care needs who are cared for at home"= "Social", 
                                "Coronary heart disease (CHD) patient hospitalisations"= "Clinical", 
                                "Life expectancy, females"= "Clinical", 
                                "Life expectancy, males"= "Clinical", 
                                "Multiple emergency hospital admissions, aged >65 years"= "Clinical", 
                                "Mid-year population estimate - aged 65+ years"= "Demographic", 
                                "Mid-year population estimate - aged 75+ years"= "Demographic", 
                                "Mid-year population estimate - aged 85+ years"= "Demographic", 
                                "Population prescribed drugs for anxiety/depression/psychosis"= "Clinical", 
                                "Psychiatric patient hospitalisations"= "Clinical",
                                "Population income deprived"="Social",
                                "Working age population employment deprived" = "Social",
                                "Children registered for free school meals"= "Social", 
                                "Single adult dwellings"= "Social"))

saveRDS(optdata, "optdata.rds")

## END
