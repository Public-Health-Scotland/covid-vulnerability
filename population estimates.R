# Population Estimates at DZ for covid PCA


###############################################.
## Packages/Filepaths/Functions ----
###############################################.
source("1.indicator_analysis.R") #Normal indicator functions

# Function to format population files as indicators
# Brings the selected numerator and denominator files, merge them together and save it
format_pops <- function(filename) {
  
  numer <- readRDS(paste0(data_folder, "Lookups/DZ11_", filename, ".rds")) %>% 
    rename(numerator = denominator) 
  
  denom <- readRDS(paste0(data_folder, "Lookups/DZ11_pop_allages.rds"))
  
  pop <- left_join(numer, denom, by = c("year", "code"))
  
  saveRDS(pop, paste0(data_folder, "Temporary/", filename, "_formatted.rds"))
}


###############################################.
## Part 1 - Creating files for each indicator ----
###############################################.
# defining list of indicators
file_list <- c("pop_65+", "pop_75+", "pop_85+")

mapply(format_pops, file_list) #formatting all files

###############################################.
## Part 2 - Running analysis function for each indicator ----
###############################################.
mapply(analyze_second, filename = file_list, measure = "percent", 
       year_type = "calendar", time_agg = 1, qa = F,
       ind_id = c(1504, 20006, 20007))



